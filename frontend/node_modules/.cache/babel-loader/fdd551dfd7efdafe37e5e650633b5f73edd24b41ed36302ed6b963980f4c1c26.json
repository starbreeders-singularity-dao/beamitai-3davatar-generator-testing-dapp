{"ast":null,"code":"/*\nThis file is part of web3.js.\n\nweb3.js is free software: you can redistribute it and/or modify\nit under the terms of the GNU Lesser General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nweb3.js is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU Lesser General Public License for more details.\n\nYou should have received a copy of the GNU Lesser General Public License\nalong with web3.js.  If not, see <http://www.gnu.org/licenses/>.\n*/\nimport WebSocket from 'isomorphic-ws';\nimport { isNullish, SocketProvider } from 'web3-utils';\nimport { ConnectionNotOpenError } from 'web3-errors';\n/**\n * Use WebSocketProvider to connect to a Node using a WebSocket connection, i.e. over the `ws` or `wss` protocol.\n *\n * @example\n * ```ts\n * const provider = new WebSocketProvider(\n * \t\t`ws://localhost:8545`,\n * \t\t{\n * \t\t\theaders: {\n * \t\t\t\t// to provide the API key if the Node requires the key to be inside the `headers` for example:\n * \t\t\t\t'x-api-key': '<Api key>',\n * \t\t\t},\n * \t\t},\n * \t\t{\n * \t\t\tdelay: 500,\n * \t\t\tautoReconnect: true,\n * \t\t\tmaxAttempts: 10,\n * \t\t},\n * \t);\n * ```\n *\n * The second and the third parameters are both optional. And you can for example, the second parameter could be an empty object or undefined.\n *  * @example\n * ```ts\n * const provider = new WebSocketProvider(\n * \t\t`ws://localhost:8545`,\n * \t\t{},\n * \t\t{\n * \t\t\tdelay: 500,\n * \t\t\tautoReconnect: true,\n * \t\t\tmaxAttempts: 10,\n * \t\t},\n * \t);\n * ```\n */\nexport default class WebSocketProvider extends SocketProvider {\n  /**\n   * This is a class used for Web Socket connections. It extends the abstract class SocketProvider {@link SocketProvider} that extends the EIP-1193 provider {@link EIP1193Provider}.\n   * @param socketPath - The path to the Web Socket.\n   * @param socketOptions - The options for the Web Socket client.\n   * @param reconnectOptions - The options for the socket reconnection {@link ReconnectOptions}\n   */\n  // this constructor is to specify the type for `socketOptions` for a better intellisense.\n  // eslint-disable-next-line no-useless-constructor\n  constructor(socketPath, socketOptions, reconnectOptions) {\n    super(socketPath, socketOptions, reconnectOptions);\n  }\n  // eslint-disable-next-line class-methods-use-this\n  _validateProviderPath(providerUrl) {\n    return typeof providerUrl === 'string' ? /^ws(s)?:\\/\\//i.test(providerUrl) : false;\n  }\n  getStatus() {\n    if (this._socketConnection && !isNullish(this._socketConnection)) {\n      switch (this._socketConnection.readyState) {\n        case this._socketConnection.CONNECTING:\n          {\n            return 'connecting';\n          }\n        case this._socketConnection.OPEN:\n          {\n            return 'connected';\n          }\n        default:\n          {\n            return 'disconnected';\n          }\n      }\n    }\n    return 'disconnected';\n  }\n  _openSocketConnection() {\n    this._socketConnection = new WebSocket(this._socketPath, undefined, this._socketOptions && Object.keys(this._socketOptions).length === 0 ? undefined : this._socketOptions);\n  }\n  _closeSocketConnection(code, data) {\n    var _a;\n    (_a = this._socketConnection) === null || _a === void 0 ? void 0 : _a.close(code, data);\n  }\n  _sendToSocket(payload) {\n    var _a;\n    if (this.getStatus() === 'disconnected') {\n      throw new ConnectionNotOpenError();\n    }\n    (_a = this._socketConnection) === null || _a === void 0 ? void 0 : _a.send(JSON.stringify(payload));\n  }\n  _parseResponses(event) {\n    return this.chunkResponseParser.parseResponse(event.data);\n  }\n  _addSocketListeners() {\n    var _a, _b, _c, _d;\n    (_a = this._socketConnection) === null || _a === void 0 ? void 0 : _a.addEventListener('open', this._onOpenHandler);\n    (_b = this._socketConnection) === null || _b === void 0 ? void 0 : _b.addEventListener('message', this._onMessageHandler);\n    (_c = this._socketConnection) === null || _c === void 0 ? void 0 : _c.addEventListener('close', e => this._onCloseHandler(e));\n    (_d = this._socketConnection) === null || _d === void 0 ? void 0 : _d.addEventListener('error', this._onErrorHandler);\n  }\n  _removeSocketListeners() {\n    var _a, _b, _c;\n    (_a = this._socketConnection) === null || _a === void 0 ? void 0 : _a.removeEventListener('message', this._onMessageHandler);\n    (_b = this._socketConnection) === null || _b === void 0 ? void 0 : _b.removeEventListener('open', this._onOpenHandler);\n    (_c = this._socketConnection) === null || _c === void 0 ? void 0 : _c.removeEventListener('close', this._onCloseHandler);\n    // note: we intentionally keep the error event listener to be able to emit it in case an error happens when closing the connection\n  }\n  _onCloseEvent(event) {\n    var _a;\n    if (this._reconnectOptions.autoReconnect && (![1000, 1001].includes(event.code) || !event.wasClean)) {\n      this._reconnect();\n      return;\n    }\n    this._clearQueues(event);\n    this._removeSocketListeners();\n    this._onDisconnect(event.code, event.reason);\n    // disconnect was successful and can safely remove error listener\n    (_a = this._socketConnection) === null || _a === void 0 ? void 0 : _a.removeEventListener('error', this._onErrorHandler);\n  }\n}\nexport { WebSocketProvider };\n//# sourceMappingURL=index.js.map","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}